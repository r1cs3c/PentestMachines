#!/bin/bash

function automatic_rebuild_update_start(){
    echo '******************************************'
    echo '***  Rebuild and update r1cs3c images  ***'
    echo '******************************************'
    
    echo ' '
    echo '[***] Docker login [***]'
    docker login
    
    ## Build new multi-arch omages for Dev and Kali update, upgrade and push.
    # initialise buildx
    docker buildx create --use
}

#Build and push Docker image for both amd64 and arm64 platforms
function build_and_push {
    docker buildx build --platform linux/amd64,linux/arm64,darwin/amd64 --push -t r1cs3c/kali_default_xrdp:latest ./
}

# Build Docker image for amd64 platform only
function build_amd64 {
    docker buildx build --platform linux/amd64 --load -t r1cs3c/kali_default_xrdp:latest ./
}

# Build Docker image for arm64 platform only
function build_arm64 {
    docker buildx build --platform linux/arm64 --load -t r1cs3c/kali_default_xrdp:latest ./
}

# Load the Docker image using docker-compose
function load {
    docker-compose up -d
}

function print_help {
    echo "Usage: ./script.sh [option]"
    echo "Options:"
    echo "  --build-and-push : Build and push Docker image for both amd64 and arm64 platforms"
    echo "  --build-amd64    : Build Docker image for amd64 platform only"
    echo "  --build-arm64    : Build Docker image for arm64 platform only"
    echo "  --load           : Load the Docker image using docker-compose"
}

automatic_rebuild_update_start

if [ $# -ne 1 ]; then
    echo "Error: Invalid number of arguments"
    print_help
else
    case $1 in
        --build-and-push)
            build_and_push
            ;;
        --build-amd64)
            build_amd64
            ;;
        --build-arm64)
            build_arm64
            ;;
        --load)
            load
            ;;
        *)
            echo "Error: Unknown option '$1'"
            print_help
            ;;
    esac
fi
