#!/bin/bash
# updates docker images
#MY IMAGES VERSION CONTROL
ubuntu_dev="r1cs3c/ubuntu-dev:0.2.0"
ubuntu_asm="r1cs3c/asm_dev:0.2.0"
kali="r1cs3c/kali_build:0.2.0"
ram_mem="4G"
docker_dev_build_folder=""
docker_kali_build_folder=""

function automatic_3rdparty_update(){
    ### ALL OTHER IMAGES UPDATE STARTS ###
    echo '******************************************'
    echo '*** updating all Images to latest version ***'
    echo '******************************************'
    #docker pull alpine/git
    #docker pull codacy/codacy-analysis-cli
    docker pull mcr.microsoft.com/powershell
    docker pull returntocorp/semgrep
}

function automatic_rebuild_update_start(){
    echo '******************************************'
    echo '***  Rebuild and update r1cs3c images  ***'
    echo '******************************************'
    
    echo ' '
    echo '[***] Docker login [***]'
    docker login
    
    ## Build new multi-arch omages for Dev and Kali update, upgrade and push.
    # initialise buildx
    docker buildx create --use
}

function automatic_ubuntu-dev_rebuild(){

    echo ' '
    echo '[***] Rebuild ubuntu-dev [***]'
    echo ' '
    docker pull r1cs3c/ubuntu-dev:latest
    docker tag r1cs3c/ubuntu-dev:latest $ubuntu_dev
    docker push $ubuntu_dev
    docker buildx build --platform linux/amd64,linux/arm64 --push -t r1cs3c/ubuntu-dev:latest ../build_dev
    docker pull r1cs3c/ubuntu-dev:latest
    
}
function interactive_ubuntu-dev_update(){
    echo ' '
    echo '******************************************'
    echo '***     updating r1cs3c/ubuntu-dev     ***'
    echo '******************************************'
    echo ' '
    docker run --rm -d --name "ubuntu_update" --memory $ram_mem -ti r1cs3c/ubuntu-dev:latest /bin/zsh
    docker commit ubuntu_update $ubunut_dev 
    docker exec -ti ubuntu_update bash -c "apt update"
    docker exec -ti ubuntu_update bash -c "apt upgrade -y"

    echo ' '
    echo '*** New Tool Installations r1cs3c/ubuntu-dev ***'
    echo ' '
    #docker exec -ti ubuntu_update bash -c "apt install firefox"
    #docker exec -ti ubuntu_update bash -c "apt install python3-pip"
    #docker exec -ti ubuntu_update bash -c "pip install netaddr"

    echo ' '
    echo '*** updating r1cs3c/ubuntu-dev - node.js ***'
    echo ' '
    docker exec -ti ubuntu_update bash -c "npm cache clean -f"
    docker exec -ti ubuntu_update bash -c "npm install -g n"
    docker exec -ti ubuntu_update bash -c "n stable"
    docker exec -ti ubuntu_update bash -c "rm /usr/bin/node*"
    docker exec -ti ubuntu_update bash -c "apt remove nodejs"
    docker exec -ti ubuntu_update bash -c "apt purge nodejs"
    # do automatic update and security check of nodejs
    docker exec -ti ubuntu_update bash -c "npm install -g npm to update"
    docker exec -ti ubuntu_update bash -c "npm audit fix --force"

    echo ' '
    echo '*** updating r1cs3c/ubuntu-dev - clean history and apt ***'
    echo ' '
    docker exec -ti ubuntu_update bash -c "history -c"
    docker exec -ti ubuntu_update bash -c "apt autoclean"
    docker exec -ti ubuntu_update bash -c "apt autoremove"
    docker commit ubuntu_update r1cs3c/ubuntu-dev:latest
    docker stop ubuntu_update

    echo ' '
    echo '*** updating r1cs3c/ubuntu-dev - push and rebuild image ***'
    echo ' ' 
    docker push r1cs3c/ubuntu-dev:latest
    automatic_ubuntu-dev_rebuild
}

function automatic_asm_dev_rebuild(){

    echo ' '
    echo '[***] Rebuild asm_dev [***]'
    docker pull r1cs3c/asm_dev:latest
    docker tag r1cs3c/asm_dev:latest $ubuntu_asm
    docker push $ubuntu_asm
    docker buildx build --platform linux/amd64,linux/arm64 --push -t r1cs3c/asm_dev:latest ../build_asm
    docker pull r1cs3c/asm_dev:latest
}
function interactive_asm_dev_update(){
    echo '******************************************'
    echo '***     updating r1cs3c/asm_dev        ***'
    echo '******************************************'
    docker run --rm -d --name "asm_update" --memory $ram_mem -ti r1cs3c/asm_dev:latest /bin/bash
    docker commit asm_update $ubuntu_asm 
    docker exec -ti asm_update bash -c "apt update"
    docker exec -ti asm_update bash -c "apt upgrade -y"

    echo ' '
    echo '*** updating r1cs3c/asm_dev - node.js ***'
    echo ' '
    # nodejs update
    docker exec -ti asm_update bash -c "npm cache clean -f"
    docker exec -ti asm_update bash -c "npm install -g n"
    docker exec -ti asm_update bash -c "n stable"
    # do automatic update and security check of nodejs
    docker exec -ti asm_update bash -c "npm install -g npm to update"
    docker exec -ti asm_update bash -c "npm audit fix --force"

    echo ' '
    echo '*** updating r1cs3c/asm_dev - clean history and apt ***'
    echo ' '
    docker exec -ti asm_update bash -c "history -c"
    docker exec -ti asm_update bash -c "apt autoclean"
    docker exec -ti asm_update bash -c "apt autoremove"
    docker commit asm_update r1cs3c/asm_dev:latest
    docker stop asm_update

    echo ' '
    echo '*** updating r1cs3c/asm_dev - push and rebuild image ***'
    echo ' '   
    docker push r1cs3c/asm_dev:latest
    automatic_asm_dev_rebuild
}

function automatice_kali_build_rebuild(){
    echo ' '
    echo '[***] Rebuild kali_build [***]'
    echo ' '
    docker pull r1cs3c/kali_build:latest
    docker tag r1cs3c/kali_build:latest $kali
    docker push $kali
    docker buildx build --platform linux/amd64,linux/arm64 --push -t r1cs3c/kali_build:latest ../build_kali
    docker pull r1cs3c/kali_build:latest
}    
function interactive_kali_build_update(){
    echo '******************************************'
    echo '***     updating r1cs3c/kali_build     ***'
    echo '******************************************'
    docker run --rm -d --name "kali_update" --memory $ram_mem -ti r1cs3c/kali_build:latest /bin/zsh
    docker commit kali_update $kali #commit as previous version
    docker exec -ti kali_update bash -c "apt update"
    docker exec -ti kali_update bash -c "apt upgrade -y"

    echo ' '
    echo '*** New Tool Installations r1cs3c/kali_build ***'
    echo ' '
    #docker exec -ti kali_update bash -c "apt install ffuf"

    echo ' '
    echo '*** updating r1cs3c/kali_build - node.js ***'
    echo ' '
    docker exec -ti kali_update bash -c "npm cache clean -f"
    docker exec -ti kali_update bash -c "npm install -g n"
    docker exec -ti kali_update bash -c "n stable"
    docker exec -ti kali_update bash -c "rm /usr/bin/node*"
    docker exec -ti kali_update bash -c "apt remove nodejs"
    docker exec -ti kali_update bash -c "apt purge nodejs"
    # do automatic update and security check of nodejs
    docker exec -ti kali_update bash -c "npm install -g npm to update"
    docker exec -ti kali_update bash -c "npm audit fix --force"

    echo ' '
    echo '*** updating r1cs3c/kali_build - clean history and apt ***'
    echo ' '
    docker exec -ti kali_update bash -c "history -c"
    docker exec -ti kali_update bash -c "apt autoclean"
    docker exec -ti kali_update bash -c "apt autoremove"
    docker commit kali_update r1cs3c/kali_build:latest
    docker stop kali_update

    echo ' '
    echo '*** updating r1cs3c/kali_build - push and rebuild image ***'
    echo ' '   
    docker push r1cs3c/kali_build:latest
    automatice_kali_build_rebuild
}

function automatic_rebuild_update_end(){
    echo '******************************************'
    echo '******************************************'
    echo '******************************************'
    echo ' '
    echo '******************************************'
    echo '* Do not forget to clean the Docker img  *'
    echo '******************************************'
}

function main(){
    #automatic_3rdparty_update

    automatic_rebuild_update_start

    #automatic_ubuntu-dev_rebuild
    #interactive_ubuntu-dev_update

    #automatic_asm_dev_rebuild
    #interactive_asm_dev_update

    #automatice_kali_build_rebuild
    interactive_kali_build_update

    automatic_rebuild_update_end

}

main