$image_name = "kali_build"
$tmp_container = "kali_temp"
$home_folder = "${PWD}\home\:/home/kali"
$opt_folder = "${PWD}\opt\:/opt"

Write-Host "*******************************************************************************"
Write-Host "*** Stage 1: Build initial image ***"
Write-Host "*******************************************************************************"
#build the base imge
docker build .\dockerfile_initial\ -t $image_name
#start image for setup
docker run -ti -d --rm --name $tmp_container -v $home_folder -v $opt_folder $image_name 
Write-Host "*******************************************************************************"
Write-Host "*** Stage 2: Install and setup VNC server - root user ***"
Write-Host "*******************************************************************************"
#Install VNC Server 
#from https://gist.github.com/yudhiwidyatama/ff784398e80380c4903bc13156d46aed
docker exec -ti $tmp_container apt-get install --no-install-recommends -y gnome-icon-theme tightvncserver xorg xserver-xorg xserver-xorg-video-dummy xfce4 xfce4-goodies 
docker exec -ti $tmp_container apt install -y dbus-x11  #resolves load error
docker exec -ti $tmp_container apt install -y kali-desktop-xfce #install kali-desktop
docker exec -ti $tmp_container rm -rf /var/lib/apt/lists/*

#docker exec -ti $tmp_container groupadd vuser && useradd -m -g vuser vuser
#docker exec -ti $tmp_container su vuser

#set vnc passwd
#docker exec -ti $tmp_container "echo kalipass | vncpasswd -f > /root/.vnc/passwd"
#docker exec -ti $tmp_container chmod 0600 /root/.vnc/passwd
#docker exec -ti $tmp_container USER=vuser


#docker exec -ti $tmp_container chmod +x /root/.vnc/xstartup
#docker exec -ti $tmp_container vncserver -kill :1

#set vnc password
docker exec -ti $tmp_container vncserver
Write-Host "*******************************************************************************"
Write-Host "*** Stage 3: Install and setup kali-linux-default ***"
Write-Host "*******************************************************************************"
#set-up kali linux default
docker exec -ti $tmp_container apt install kali-linux-default
#setup metasploit
docker exec -ti $tmp_container service postgresql start
docker exec -ti $tmp_container msfdb init 

Write-Host "*******************************************************************************"
Write-Host "*** Stage 4: Save kali_build image ***"
Write-Host "*******************************************************************************"
#save image
docker commit $tmp_container $image_name

Write-Host "*******************************************************************************"
Write-Host "*** Stage 5: Compile final image ***"
Write-Host "*******************************************************************************"
docker build .\dockerfile_final\ -t $image_name

#stop image
docker stop $tmp_container
###########12345678901234567890123456789012345678901234567890123456789012345678901234567890###
Write-Host "*******************************************************************************"
Write-Host "To run, use docker-compose up -d"
Write-Host "user kali/kali been added but vncserver is running as root, home folder loaded "
Write-Host "to user kali in location /home/kali"
Write-Host "*******************************************************************************"
